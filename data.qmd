# Data

```{r}
library(haven)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(forcats)
```

```{r}


# DEMO
demo_13 <- read_xpt("DEMO_13_14.XPT")
demo_17 <- read_xpt("DEMO_17_18.XPT")
demo_21 <- read_xpt("DEMO_21_23.XPT")

# BMI Body Measures (BMX)
bmx_13 <- read_xpt("BMX_13_14.XPT")
bmx_17 <- read_xpt("BMX_17_18.XPT")
bmx_21 <- read_xpt("BMX_21_23.XPT")

# Reproductive Health (RHQ)
repro_13 <- read_xpt("RHQ_13_14.XPT")
repro_17 <- read_xpt("RHQ_17_18.XPT")
repro_21 <- read_xpt("RHQ_21_23.XPT")

# Physical Activity (PAQ)
activity_13 <- read_xpt("PAQ_13_14.XPT")
activity_17 <- read_xpt("PAQ_17_18.XPT")
activity_21 <- read_xpt("PAQ_21_23.XPT")




```


```{r}


# 2013–2014
activity_13_clean <- activity_13 |>
  mutate(
    PAD680 = na_if(PAD680, 7777),
    PAD680 = na_if(PAD680, 9999)
  )
# note: SEQN is still here!

# 2017–2018
activity_17_clean <- activity_17 |>
  mutate(
    PAD680 = na_if(PAD680, 7777),
    PAD680 = na_if(PAD680, 9999)
  )

# 2021–2023
activity_21_clean <- activity_21 |>
  mutate(
    PAD680 = na_if(PAD680, 7777),
    PAD680 = na_if(PAD680, 9999)
  )




nhanes_13 <- demo_13 |>
  select(SEQN, RIDAGEYR,RIAGENDR) |>
  left_join(bmx_13 |> select(SEQN, BMXBMI), by = "SEQN") |>
  left_join(repro_13 |> select(SEQN, RHQ131, RHQ074), by = "SEQN") |>
  left_join(activity_13_clean |> select(SEQN, PAD680), by = "SEQN") |>
  rename(
    age              = RIDAGEYR,
    sex = RIAGENDR,
    bmi              = BMXBMI,
    ever_pregnant    = RHQ131,
    infertility_12mo = RHQ074,
    sedentary_min_day = PAD680
  ) |>
  mutate(cycle = "2013-2014")




nhanes_17 <- demo_17 |>
  select(SEQN, RIDAGEYR,RIAGENDR) |>
  left_join(bmx_17 |> select(SEQN, BMXBMI), by = "SEQN") |>
  left_join(repro_17 |> select(SEQN, RHQ131, RHQ074), by = "SEQN") |>
  left_join(activity_17_clean |> select(SEQN, PAD680), by = "SEQN") |>
  rename(
    age              = RIDAGEYR,
    sex = RIAGENDR,
    bmi              = BMXBMI,
    ever_pregnant    = RHQ131,
    infertility_12mo = RHQ074,
    sedentary_min_day = PAD680
  ) |>
  mutate(cycle = "2017-2018")






nhanes_21 <- demo_21 |>
  select(SEQN, RIDAGEYR,RIAGENDR) |>
  left_join(bmx_21 |> select(SEQN, BMXBMI), by = "SEQN") |>
  left_join(repro_21 |> select(SEQN, RHQ131), by = "SEQN") |>
  left_join(activity_21_clean |> select(SEQN, PAD680), by = "SEQN") |>
  rename(
    age              = RIDAGEYR,
    sex = RIAGENDR,
    bmi              = BMXBMI,
    ever_pregnant    = RHQ131,
    sedentary_min_day = PAD680
    #infertility_12mo = RHQ074 does not exist
  ) |>
  mutate(cycle = "2021-2023")


# activity_21_clean <- activity_21 |>
#   mutate(
#     # Missing codes
#     PAD810Q = na_if(PAD810Q, 7777),
#     PAD810Q = na_if(PAD810Q, 9999),
#     PAD820  = na_if(PAD820, 7777),
#     PAD820  = na_if(PAD820, 9999),
# 
#     freq_per_day = case_when(
#       PAD810U == "D" ~ PAD810Q,
#       PAD810U == "W" ~ PAD810Q / 7,
#       PAD810U == "M" ~ PAD810Q * (12/365),
#       PAD810U == "Y" ~ PAD810Q / 365,
#       TRUE ~ NA_real_
#     ),
# 
#     vigorous_min_day = freq_per_day * PAD820
#   )





nhanes_all <- bind_rows(nhanes_13, nhanes_17, nhanes_21)


#FILTER FOR WOMEN
nhanes_women <- nhanes_all |>
  filter(sex == 2)


```

```{r}
# Install once if needed:
#install.packages("labelled")

# # Put your activity datasets in a named list
# activity_list <- list(
#   `2013-2014` = activity_13,
#   `2017-2018` = activity_17,
#   `2021-2023` = activity_21_clean
# )
# 
# # For each cycle: print the label and summary of PAD615
# for (cyc in names(activity_list)) {
#   cat("\n============================\n")
#   cat("Cycle:", cyc, "\n")
#   cat("============================\n")
#   
#   df <- activity_list[[cyc]]
#   
#   # Check if PAD615 exists in this dataset
#   if (!"PAD615" %in% names(df)) {
#     print(var_label(df$vigorous_min_day))
#   } else {
#     cat("Label for PAD615:\n")
#     print(summary(df$PAD615))
#     
#     
#   }
# }

```



```{r}
head(nhanes_women)
```


## Description




## Missing value analysis

```{r}
nhanes_women |>
  summarise(across(everything(), ~ sum(is.na(.)))) |>
  pivot_longer(cols = everything(),
               names_to = "variable",
               values_to = "missing") |>
  ggplot(aes(x = reorder(variable, missing), y = missing)) +
  geom_col(fill = "#6DAEDB") +
  coord_flip() +
  labs(title = "Missing Values per Variable",
       x = "Variable",
       y = "Number of Missing Values") +
  theme_minimal(base_size = 12)
```



```{r}
ggplot(
  nhanes_women |>
    group_by(cycle) |>
    summarise(across(
      c("bmi", "ever_pregnant", "infertility_12mo", "sedentary_min_day"),
      ~ mean(is.na(.))
    )) |>
    pivot_longer(cols = -cycle,
                 names_to = "variable",
                 values_to = "missing_prop"),
  aes(x = fct_reorder(variable, missing_prop), 
      y = missing_prop, 
      fill = cycle)
) +
  geom_col(position = "dodge") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title = "Missing Data Proportion by Variable and Cycle",
       x = "Variable",
       y = "% Missing") +
  theme_minimal(base_size = 12)

```



```{r}

vars <- c("bmi", "ever_pregnant", "infertility_12mo", "sedentary_min_day")

miss_prop <- nhanes_women |>
  select(cycle, all_of(vars)) |>
  pivot_longer(
    cols = -cycle,
    names_to = "variable",
    values_to = "value"
  ) |>
  group_by(cycle, variable) |>
  summarise(prop_missing = mean(is.na(value)), .groups = "drop")

miss_prop


```


```{r}

ggplot(miss_prop,
       aes(x = variable, y = cycle, fill = prop_missing)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red",
                      labels = scales::percent_format(accuracy = 1),
                      name = "% missing") +
  labs(
    title = "Proportion of Missing Data by Variable and NHANES Cycle",
    x = "",
    y = ""
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )




```

```{r}

```


